---
title: "AHRQ Deliveries process testing"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

The purpose of this notebook is to process test data from multiple quarters of [THCIC in-patient public use data files](https://www.dshs.texas.gov/thcic/hospitals/Inpatientpudf.shtm) into a single data file of deliveries without complications. This requires importing and applying several filtering options.

The methods in this notebook are used in `01-process-loop` to process multiple years of data. This notebook cannot support that amount of data, but was used to check various steps in the filtering process for the main script.

Please see the `01-process-loop` for more additional details.

There is another notebook `01-process-lists` where various AHRQ lists of ICD-10 and other codes are defined separately. Those values are written out to the `procedures-lists` folder as .rds and .csv files and then imported into this notebook and others. See that notebook to inspect the lists.

```{r setup, echo=T, results='hide', message=F, warning=F}
library(fs)
library(tidyverse)
```

## Set up import

We search through the `data` folder to build a list files to import into this notebook. The test data was created using the first 10,000 rows from one quarter of four years, 2016-2019.

```{r dirs_test}
# set up test data
test_data_dir <- "data-test"
test_tsv_files <- dir_ls(test_data_dir, recurse = TRUE, regexp = "test_base1")
test_tsv_files
```

## Import the base1 files

At this time, our analysis utilizes only one (PUDF_base1) of several files in the release for each quarter.

Of note:

- There is a trailing tab on each row, whic brings in an unnecssary column. This is removed with `col_skip()`. The `EMERGENCY_DEPT_FLAG` col was introduced in 2017, so we have to remove two differnet "last columns".
- We set default type as col_character because some cols will appear as logical. We reset necessary cols as numbers where necessary.

```{r import, echo=T, results='hide', message=F, warning=F}
# warnings are suppressed, so check problems()
# add/remove test_ as necessary
base1 <- test_tsv_files %>%
  map_dfr(
    read_tsv,
    col_types = cols(
      .default = col_character(),
      X168 = col_skip(),
      X167 = col_skip()
    )
  ) %>% 
  mutate_at(
    vars(contains("_CHARGES")), as.numeric
  )


# number of rows
base1 %>% nrow()

# klaxon for import complete
# beepr::beep(3)

## peek at columns and types
# base1 %>% glimpse()
```

## Filtering for deliveries

### Filtering muliple columns, multiple conditions

The logic here looks through a number of columns for a number of ICD codes.

In ths case, we are looking at all columns with "DIAG" in name for values in the `delivery_icd` list, which comes from "DELOCMD*" in our IQI 21 reference.

First we'll test our logic to find the columns:

```{r base_names}
base1 %>% 
  select(
    matches("_DIAG"),
    -starts_with("POA")
    ) %>% 
  names()
```

Then we import the DELOCMD list and filter for it.

```{r deliveries}
delocmd_list <- read_rds("procedures-lists/ahrq_delocmd.rds") %>% .$delocmd

del <- base1 %>% 
  filter_at(
    vars(
      matches("_DIAG"),
      -starts_with("POA")
    ),
    any_vars(
      . %in% delocmd_list
    )
  )

del %>% nrow()
```

We peek here at the resulting frame to eyeball codes.

```{r peek_del}
del %>% 
  select(
    matches("_DIAG"),
    -starts_with("POA")
  ) %>% head(10)

```

## Exclusions from the deliveries

From IQI 21 ... Exclude cases:

- with any listed ICD-10-CM diagnosis codes for abnormal presentation, fetal death, or multiple gestation (Appendix A: PRCSECD) and
- with missing gender (SEX=missing), age (AGE=missing), quarter (DQTR=missing), year (YEAR=missing) or principal diagnosis (DX1=missing)

### Get PRCSECD list

We first need the list of PRCSECD codes from IQI_Appendix_A.pdf: "Abnormal presentation, fetal death and multiple gestation diagnosis codes: (PRCSECD)."

The list of codes was extracted from the PDF and cleaned in OpenRefine to get full list. Details in `procedures/iqi-appendex-a` folder.

### Import list of PRCSECD codes

```{r read_prcsecd}
# read in the file
prcsecd <- read_csv("procedures/iqi-appendex-a/IQI_Appendix_A.csv")

# number of codes
prcsecd %>% nrow()

# turn it into a list
prcsecd_list <- prcsecd %>% as_vector()
```

### Filter out deliveries based on PRCSECD codes

When we are looking for a negative, we have to consider "all_vars" instead of "any_vars".

```{r prcsecd}

del_ucmp <- del %>% 
  filter_at(
    vars(
      contains("_DIAG"),
      -starts_with("POA")
    ),
    all_vars(
      !(. %in% prcsecd_list)
    )
  )

del_ucmp %>% nrow()
```

### Filter out blank cells per Appendix A

"with missing gender (SEX=missing), age (AGE=missing), quarter (DQTR=missing), year (YEAR=missing) or principal diagnosis (DX1=missing)."

In base1, the fields are `SEX_CODE`, `PAT_AGE`, `DISCHARGE` for both quarter and year, and `PRINC_DIAG_CODE`.

```{r clean}

del_ucmp_cln <- del_ucmp %>% 
  filter(
    SEX_CODE == "F",
    PAT_AGE != "`",
    RACE != "`",
    !is.na(DISCHARGE),
    !is.na(PRINC_DIAG_CODE)
  )

del_ucmp_cln %>% nrow()
```

### Child-bearing age

Researchers at the Office of Health Affairs-Population Health, The University of Texas System work with the THCIC file daily and they suggest to filter deliveries to women of normal child-bearing age.

We'll look here how those ages break down in the cleaned file:

```{r peek_age}
del_ucmp_cln %>% 
  count(PAT_AGE)
```

The codes for the ages 15-49 include 05-12. For HIV or drug patients it includes 23 (18-44 yrs). I import those from `procedures-lists`.

Here we will filter for those values.

```{r age}
age_list <- read_rds("procedures-lists/utoha_age.rds") %>% .$age

del_ucmp_cln_age <- del_ucmp_cln %>% 
  filter(PAT_AGE %in% age_list)

del_ucmp_cln_age %>% nrow()
```

Peeking at records outside the child-bearing age list.

```{r age_test}
# set up not in
`%ni%` <- Negate(`%in%`)

del_ucmp_cln %>% 
  filter(PAT_AGE %ni% age_list) %>% 
  select(PAT_AGE) %>% 
  count(PAT_AGE)
```


## Add convenience columns for dates

```{r add_yr}
del_ucmp_cln_age <- del_ucmp_cln_age %>% 
  mutate(
    YR = substr(DISCHARGE, 1, 4)
  )
```

## Remove other years

Because of a reporting lag, there are years in the original data that we are not using for our analysis. At some point in 2015 there was a switch from ICD-9 to ICD-10 coding, so going eariler would require some conversions. Not impossible, but not in scope at this time to ease complication.

We are using full years from 2016-2018 and a partial year 2019 through the 2nd quarter release. 

```{r filter_yr}
del_ucmp_cln_age_yr <- del_ucmp_cln_age %>% 
  filter(YR %in% c("2016", "2017", "2018", "2019"))
```

## Write file

```{r write}
del_ucmp_cln_age_yr %>% nrow()
del_ucmp_cln_age_yr %>% write_rds("data-test/ahrq_del_ucmp_single_test.rds")

beepr::beep(4)

```

