---
title: "Clean provider names"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

By **Christian McDonald**, Assistant Professor of Practice\
School of Journalism, Moody College of Communication\
University of Texas at Austin

---
## Troubleshooting

- Find out where this file came from: 20200204 THCIC Facility List.xlsx. It happens to list our problem hospitals with their double THCIC_ID values. Why don't these have info? Or why did they change TCHIC_ID (Baylor Scott & White hospitals). As the state?
- Can I create a cleaning notebook that:
  - takes del or prividers and fixes the IDs for those that changes, like BS&W? Could rename as _orig, fix and call THCIC_ID to preserve other notebooks?
  - Adds missing info on places like Bay Area Regional Medical Center?
---


Hospital names change over time, causing problems for any analysis that groups or aggregates by the PROVIDER_NAME.

This notebook provides a list of THCIC_IDs with first their official name from the Current Facility Contact Information found at [Outpatient Data Reporting Requirements](https://www.dshs.texas.gov/thcic/OutpatientFacilities/OutpatientReportingRequirements.shtm). If the case's THCIC_ID is not listed in the facilities list, then the facilities' most recent name is used.

There are cases in the original data where possibly the ID changed for a hospital over time.

Looking for the process that cleans provider names based on this notebook?

```r
# Import updated providers list
providers_list <- read_rds("procedures-lists/providers_cleaned.rds")

# Update provider names
data_cleaned <- data_orig %>% # or assign back to the same dataframe
  left_join(providers_cleaned, by = "THCIC_ID") %>% 
  select(-PROVIDER_NAME) %>% 
  rename(PROVIDER_NAME = PROVIDER_NAME_CLEANED)
```

## Setup

```{r setup, echo=T, results='hide', message=F, warning=F}
library(tidyverse)
library(janitor)
library(readxl)
```

## Importing the data

We start with all delivery data per AHRQ standards since it is our largest collected dataset. The facilities list is noted above.

```{r imports}
### production data
path_prod <- "data-processed/ahrq_del_all.rds"

del <- read_rds(path_prod)

del %>% nrow()

### facilities list
facilities_list <- read_excel("resources/FacilityList_20200623.xlsx") %>% clean_names()
```

### Troubleshooting some things


```{r}
del %>% 
  distinct(THCIC_ID, PROVIDER_NAME) %>% 
  count(THCIC_ID, PROVIDER_NAME) %>% 
  arrange(PROVIDER_NAME)
```
### Centennial

```{r}
del %>% 
  filter(str_detect(PROVIDER_NAME, "Centennial")) %>% 
  count(YR, THCIC_ID, PROVIDER_NAME)
```
```{r}
facilities_list %>%
  filter(str_detect(facility, "Centennial"))
```



### How many distinct IDs are there?

We want to ensure that we have one provider name for each THCIC, so let's first check how many there are in the dataset.

```{r counts}
del %>% 
  distinct(THCIC_ID) %>% 
  nrow()

facilities_list %>% 
  distinct(thcic_id) %>% 
  nrow()
```

## Process for cleaning the provider name

- get distinct id, name, quarter
  - arrange by id, quarter so we can find the most recent version
  - group and slice the most recent name, creating a new col with the recent name
- join with facilities_list to get the official name
  - In some cases the id is not in the facilities list. In those cases, use case_when to use "recent" name

The concept of group and slice from the tail by row_number came from [this stack overflow article](https://stackoverflow.com/a/53994503/2909130).

```{r providers_cleaned}
providers_cleaned <- del %>% 
  distinct(THCIC_ID, PROVIDER_NAME, DISCHARGE) %>% 
  arrange(THCIC_ID, DISCHARGE) %>% 
  select(THCIC_ID, PROVIDER_NAME) %>% 
  group_by(THCIC_ID) %>% 
  slice(tail(row_number(), 1)) %>% 
  rename(PROVIDER_NAME_RECENT = PROVIDER_NAME) %>% 
  left_join(facilities_list, by = c("THCIC_ID" = "thcic_id")) %>% 
  select(THCIC_ID, PROVIDER_NAME_RECENT, facility, city) %>% 
  # Create new provider name and fill from facilities list
  mutate(
    PROVIDER_NAME_CLEANED = case_when(
       is.na(facility) ~ PROVIDER_NAME_RECENT,
       TRUE ~ facility
    )
  ) %>% 
  rename(
    PROVIDER_CITY = city
  ) %>% 
  select(THCIC_ID, PROVIDER_NAME_CLEANED, PROVIDER_CITY) %>% 
  arrange(PROVIDER_NAME_CLEANED)

providers_cleaned %>% nrow()
providers_cleaned %>% head()
```

Check for duplicate ids in cleaned list.

```{r test_id}
providers_cleaned %>% 
  count(THCIC_ID) %>% 
  filter(n > 1)
```
Check for duplicate names in cleaned list.

```{r test_name}
providers_cleaned %>% 
  count(PROVIDER_NAME_CLEANED) %>% 
  filter(n > 1)
```
### Records with no match

There are a number of cases where there is a `THCIC_ID` used in our data that does not have a match in the most recent facilities list. You can see these by searching the cleaned providers for records with no `PROVIDER_CITY`.

```{r no_match_list}
providers_cleaned %>% 
  filter(is.na(PROVIDER_CITY))
```

Coincidentally, every one of these providers were listed in a _previous_ version of the facilities list (also in the resources folder), but without address information. Sometimes they were duplicates of a hospital with the same name but a different `thcic_id`.

In short, there is nothing we can do with this other than to perhaps exclude them. It amounts to about 41K out of 1.37M records, or about 3% of records.

## Test run on the data

This is what we'll need in each workbook where we want to cleaned names.

```{r list_test}
del_cleaned <- del %>% # or assign back to the same dataframe
  left_join(providers_cleaned, by = "THCIC_ID") %>% 
  select(-PROVIDER_NAME) %>% 
  rename(PROVIDER_NAME = PROVIDER_NAME_CLEANED)
```

Now we'll check for provider names with more than one id. In some cases these are different hospitals with the same name in different cities (Memorial Hospital). In others it just is what it is: the data has more than one id for the hospital name (Baylor Scott & White entries).

### Hospitals with more than one ID

Oakbend has two THCIC_IDs in the data.

```{r list_test_errors}
del_cleaned %>% 
  distinct(THCIC_ID, PROVIDER_NAME, PROVIDER_CITY) %>% 
  count(PROVIDER_NAME, PROVIDER_CITY) %>% 
  filter(n > 1)

del_cleaned %>% 
  distinct(THCIC_ID, PROVIDER_NAME, PROVIDER_CITY) %>% 
  filter(str_detect(PROVIDER_NAME, "Oakbend"))
```

### Number of deliveries with no provider match

The number of records among all deliveries that don't have a `THCIC_ID` match in the facilities list. The list of hospitals is above.

```{r no_match_count}
del_cleaned %>% 
  filter(is.na(PROVIDER_CITY)) %>% 
  nrow()
```
### Memorial Hospital

There are three different hospitals in three different cities with the name "Memorial Hospital".

```{r}
providers_list_full %>% 
  filter(provider_name_cleaned == "Memorial Hospital")
```



## Providers export

```{r providers_export}
providers_list_full <- del %>% 
  distinct(THCIC_ID, PROVIDER_NAME, DISCHARGE) %>% 
  arrange(THCIC_ID, DISCHARGE) %>% 
  select(THCIC_ID, PROVIDER_NAME) %>% 
  group_by(THCIC_ID) %>% 
  slice(tail(row_number(), 1)) %>% 
  rename(PROVIDER_NAME_RECENT = PROVIDER_NAME) %>% 
  left_join(facilities_list, by = c("THCIC_ID" = "thcic_id")) %>% 
  select(THCIC_ID, PROVIDER_NAME_RECENT, facility, address, city, county, zip, facility_type, state_license_number) %>% 
  # Create new provider name and fill from facilities list
  mutate(
    PROVIDER_NAME_CLEANED = case_when(
       is.na(facility) ~ PROVIDER_NAME_RECENT,
       TRUE ~ facility
    )
  ) %>% 
  select(-PROVIDER_NAME_RECENT, -facility) %>% 
  select(THCIC_ID, PROVIDER_NAME_CLEANED, everything()) %>% 
  clean_names()
```

## Exports and writes

```{r export}
# write the file
providers_cleaned %>%
  write_rds("procedures-lists/providers_cleaned.rds")

providers_list_full %>% 
  write_csv("exports/providers_export.csv")

# klaxon to sound completion
beepr::beep(4)
```

