---
title: "Summary statistics, 2016-3q2019"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

By **Christian McDonald**, Assistant Professor of Practice\
School of Journalism, Moody College of Communication\
University of Texas at Austin

## Purpose of the notebook

Each of the other analysis notebooks in the project export two types of summaries for each measure: statewide rates and averages of hospital rates. This notebook simply brings them all together into a single data file for export.

There are some additional data combinations for interactives.

```{r setup, echo=T, results='hide', message=F, warning=F}
library(fs)
library(tidyverse)
library(jsonlite)
```

## Summary imports

```{r imports}
# set up folder
data_dir <- "data-processed"
# find the files
summary_files <- dir_ls(data_dir, recurse = TRUE, regexp = "_summary")
# peek at them
summary_files

# read and combine
summary_data <- summary_files %>%
  map_dfr(read_rds) %>% 
  arrange(SUMMARY, CATEGORY, YR)

# finished data
summary_data
```

### Summary exports

```{r exports_summary}
summary_data %>% 
  write_csv("exports/summary_data.csv")
```


## Interactives exports

### Import pcsec and epi rates, providers

```{r hospitals_import}
pcsec <- read_rds("data-processed/ahrq_pcsec_rate_hosp_yr.rds")
epi <- read_rds("data-processed/lf_epi_rate_hosp_yr.rds")
providers_list <- read_rds("procedures-lists/providers_cleaned.rds")
```

### Hospitals table

Filters and assembles 2019 data for hospitals table.

```{r hosp_table_2019}
## filter and select for 2019
pcsec_2019 <- pcsec %>% 
  filter(YR == 2019) %>% 
  ungroup() %>% 
  select(THCIC_ID, PCRATE)

epi_2019 <- epi %>% 
  filter(YR == 2019) %>% 
  ungroup() %>% 
  select(THCIC_ID, EPIRATE)
```

### Assemble table for output

```{r hosp_table_assemble}
# assemble
table_2019 <- providers_list %>% 
  rename(PROVIDER_NAME = PROVIDER_NAME_CLEANED) %>% 
  left_join(pcsec_2019, by = "THCIC_ID") %>% 
  left_join(epi_2019, by = "THCIC_ID")

# write
table_2019 %>% 
  write_csv("exports/table_2019.csv")

# peek
table_2019

```

## Data export: charts by year

### Assemble Texas averages

```{r}
chart_texas <- summary_data %>% 
  filter(
    SUMMARY == "TX",
    CATEGORY %in% c("EPISIOTOMY", "PRIMARY_CESAREAN")
  ) %>% 
  select(-MEASUREMENT) %>% 
  pivot_wider(names_from = CATEGORY, values_from = VALUE) %>% 
  rename(
    EPIRATE = EPISIOTOMY,
    PCRATE = PRIMARY_CESAREAN,
    THCIC_ID = SUMMARY
  ) %>% 
  mutate(
    PROVIDER_NAME = "Texas"
  ) %>% 
  # select to order
  select(
    YR, THCIC_ID, PROVIDER_NAME, PCRATE, EPIRATE
  ) %>% 
  arrange(YR)

# peek
chart_texas
```

### Assemble charts by year

```{r}
# build table from data
chart_rates <- pcsec %>% 
  ungroup() %>% 
  select(YR, THCIC_ID, PCRATE) %>% 
  full_join(
    epi %>%
    ungroup() %>% 
    select(YR, THCIC_ID, EPIRATE)
  ) %>% 
  left_join(
    providers_list %>%
      rename(PROVIDER_NAME = PROVIDER_NAME_CLEANED) %>% 
      select(-PROVIDER_CITY)
    ) %>% 
  # reselect cols to order
  select(YR,THCIC_ID, PROVIDER_NAME, PCRATE, EPIRATE) %>% 
  arrange(PROVIDER_NAME, YR)

# peek
chart_rates %>% head(8)
```
### Bind Texas to rates

And write to JSON.

```{r}
chart_data <- chart_texas %>% 
  rbind(chart_rates)

chart_data %>% 
  write_json("exports/chart_data.json")

# peek
chart_data %>% head(12)
```

## Alt bind method for json

This adds the texas values for a given year to each hospitals' yearly data.

```{r}
chart_data_v2 <- chart_rates %>%
  left_join(
    chart_texas %>%
      select(YR, PCRATE, EPIRATE) %>% 
      rename(TXPCRATE = PCRATE, TXEPIRATE = EPIRATE),
    by = "YR")

chart_data_v2 %>% 
  write_json("exports/chart_data_v2.json")

## peek
chart_data_v2
```

## Closing

```{r close}
# A klaxon to indicate the processing is complete
beepr::beep(4)
```


