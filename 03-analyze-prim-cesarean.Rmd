---
title: "Cesarean delivery rates"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

This analysis of the Primary Cesarean Delivery Rate, Uncomplicated, as defined by [AHRQ IQI 33](https://www.qualityindicators.ahrq.gov/Downloads/Modules/IQI/V2019/TechSpecs/IQI_33_Primary_Cesarean_Delivery_Rate_Uncomplicated.pdf) from 2019.

## NUMERATOR

Discharges, among cases meeting the inclusion and exclusion rules for the denominator, with either:
- MS-DRG codes for Cesarean delivery (PRCSE2G* ) without any-listed ICD-10-PCS procedure codes for hysterotomy (PRCSE2P* ) or
- any-listed ICD-10-PCS procedure codes for Cesarean delivery (PRCSECP* ) without any-listed ICD- 10-PCS procedure codes for hysterotomy (PRCSE2P* ).

## DENOMINATOR

All deliveries, identified by any-listed ICD-10-CM diagnosis code for outcome of delivery (DELOCMD* ).

### DENOMINATOR EXCLUSIONS

Exclude cases:
- with any-listed ICD-10-CM diagnosis codes for abnormal presentation, preterm, fetal death, or multiple gestation (Appendix A: PRCSECD)
- with any-listed ICD-10-CM diagnosis codes for previous Cesarean delivery (PRVBACD* )
- with missing gender (SEX=missing), age (AGE=missing), quarter (DQTR=missing), year (YEAR=missing) or principal diagnosis (DX1=missing)


```{r setup, echo=T, results='hide', message=F, warning=F}
library(tidyverse)
library(janitor)
library(readxl)
library(DT)
library(plotly)
library(lubridate)
```


## Import of deliveries

We start with data that has already been through some "denominator" exclusions, including filtered for PRCSECD codes and any missing data. This was handled in `01-process-loop`, so we import that resulting file. Important to note with this analysis is these cases do have patients with previous cesareans, so those will have to be filtered out in later steps.

```{r imports}
# currently using test data
del <- read_rds("data-test/ahrq_del_ucmp_ptest.rds")
del %>% nrow()
```

## Set up various ICD-10 lists

These are lists from the IQI 33 reference used for filtering and such. See 01-process-lists for definitions.

```{r lists}
# diagnostic columns
diag_cols <- read_rds("data-processed/cols_diag.rds") %>% as_vector()

# Cesarean delivery MS-DRG codes: (PRCSE2G)
prcse2g_list <- read_rds("data-processed/ahrq_prcse2g.rds") %>% as_vector()

# Hysterotomy procedure codes: (PRCSE2P)
prcse2p_list <- read_rds("data-processed/ahrq_prcse2p.rds") %>% as_vector()

# Previous Cesarean delivery diagnosis codes: (PRVBACD)
prvbacd_list <- read_rds("data-processed/ahrq_prvbacd.rds") %>% as_vector()
```


## Filter deliveries to set DENOMINATOR

For this analysis, we need to additionally exclude outcomes "with any-listed ICD-10-CM diagnosis codes for previous Cesarean delivery (PRVBACD*)". This ??prvcad_list?? comes from the AHRQ specification.

> check prvcad_list. I think I just refrenced the wrong one.

```{r nprv}
del_nprv <- del %>% 
  filter_at(
    vars(diag_cols),
    all_vars(
      !(. %in% prvbacd_list)
    )
  )

del_nprv %>% nrow()
```

This completes our "DENOMINATOR" set of data.

## Code records for NUMERATOR

To code our remaining files for those that are a primary csection, we will use a long `case_when` function to look through a series of columns for a number of diagnostic codes, and then code columns accordingly.

> THIS IS WHERE I STOPPED.

```{r}

# del_nprv %>% 
#   mutate(
#     PCBIRTH = case_when(
#       MS_DRG %in% prcse2g ~ TRUE,
#       
#       TRUE ~ FALSE
#     )
#   ) %>%
#   count(PCBIRTH)

```

