---
title: "Cesarean delivery rates"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

This analysis of the Primary Cesarean Delivery Rate, Uncomplicated, as defined by [AHRQ IQI 33](https://www.qualityindicators.ahrq.gov/Downloads/Modules/IQI/V2019/TechSpecs/IQI_33_Primary_Cesarean_Delivery_Rate_Uncomplicated.pdf) from 2019:

First-time Cesarean deliveries without a hysterotomy procedure per 1,000 deliveries. Excludes deliveries with complications (abnormal presentation, preterm delivery, fetal death, multiple gestation diagnoses, or breech procedure).

We may have enough to not define as "per 1,000 deliveries".

## NUMERATOR

Discharges, among cases meeting the inclusion and exclusion rules for the denominator, with either:

- MS-DRG codes for Cesarean delivery (PRCSE2G* ) without any-listed ICD-10-PCS procedure codes for hysterotomy (PRCSE2P* ) or
- any-listed ICD-10-PCS procedure codes for Cesarean delivery (PRCSECP* ) without any-listed ICD- 10-PCS procedure codes for hysterotomy (PRCSE2P* ).

## DENOMINATOR

All deliveries, identified by any-listed ICD-10-CM diagnosis code for outcome of delivery (DELOCMD* ).

### DENOMINATOR EXCLUSIONS

Exclude cases:

- with any-listed ICD-10-CM diagnosis codes for abnormal presentation, preterm, fetal death, or multiple gestation (Appendix A: PRCSECD)
- with any-listed ICD-10-CM diagnosis codes for previous Cesarean delivery (PRVBACD* )
- with missing gender (SEX=missing), age (AGE=missing), quarter (DQTR=missing), year (YEAR=missing) or principal diagnosis (DX1=missing)

```{r setup, echo=T, results='hide', message=F, warning=F}
library(tidyverse)
library(janitor)
```

## Import of deliveries

We start with data that has already been through some "denominator" exclusions, including filtered for PRCSECD codes and any missing data. This was handled in `01-process-loop`, so we import that resulting file. Important to note with this analysis is the imported cases _DO_ have patients with previous cesareans, so those will have to be filtered out in a later step.

```{r imports}
### production data
del <- read_rds("data-processed/ahrq_del_ucmp.rds")

### testing data
# del <- read_rds("data-test/ahrq_del_ucmp_ptest.rds")

### single quarter unfiltered for testing
# del <- read_tsv("data-raw/PUDF 1Q2018 tab-delimited/PUDF_base1_1q2018_tab.txt")

del %>% nrow()
```

## Set up various ICD-10 lists

These are lists from the IQI 33 reference used for filtering and such. See 01-process-lists for definitions.

```{r lists}
# diagnostic columns
diag_cols <- read_rds("procedures-lists/cols_diag.rds") %>% .$diag

# surgical procedure columns
surg_cols <- read_rds("procedures-lists/cols_surg.rds") %>% .$surg

# Cesarean delivery MS-DRG codes: (PRCSE2G)
prcse2g_list <- read_rds("procedures-lists/ahrq_prcse2g.rds") %>% .$prcse2g

# Hysterotomy procedure codes: (PRCSE2P)
prcse2p_list <- read_rds("procedures-lists/ahrq_prcse2p.rds") %>% .$prcse2p

# Previous Cesarean delivery diagnosis codes: (PRVBACD)
prvbacd_list <- read_rds("procedures-lists/ahrq_prvbacd.rds") %>% .$prvbacd
```

## Filter deliveries to set DENOMINATOR

For this analysis, we need to additionally exclude outcomes "with any-listed ICD-10-CM diagnosis codes for previous Cesarean delivery (PRVBACD*)". This prvbacd_list comes from the AHRQ specification.

```{r nprv}
del_nprv <- del %>% 
  filter_at(
    vars(diag_cols),
    all_vars(
      !(. %in% prvbacd_list)
    )
  )

del_nprv %>% nrow()
```

This completes our "DENOMINATOR" set of data.

## Code records for NUMERATOR

The AHRQ spec defines two ways to find this. This first is:

"MS-DRG codes for Cesarean delivery (PRCSE2G* ) without any-listed ICD-10-PCS procedure codes for hysterotomy (PRCSE2P*)."

How we handle this:

- Create a cesarean column based on MS-DRG codes. This is an easy `if_else`.
- Create a column that is hysterotomy. This is more complicated because we have to look through each SURG_PROC column for any value in the prcse2p_list.
- Create our primary csection column based on cesarean true and hysterotomy being false.

### Create column for PRCSE2G or cesarean deliveries

Simple if_else statement.

```{r csec}
del_csec <- del_nprv %>% 
  mutate(
    PRCSE2G = if_else(MS_DRG %in% prcse2g_list, T, F)
  )

del_csec %>% 
  count(PRCSE2G)
```

### Create column based on hysterotomy

... "without any-listed ICD-10-PCS procedure codes for hysterotomy (PRCSE2P)."

It is not surprising that there are zero results here as these are "Abortion of Products of Conception" procedures . Abortions are filtered out in the method used to define deliveries.

> This is a code block that I would like to refactor as a loop through the `surg_cols` list.

```{r hyst}

#case_when version
del_csec <- del_csec %>% 
  mutate(
    PRCSE2P = case_when(
      PRINC_SURG_PROC_CODE %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_1 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_2 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_3 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_4 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_5 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_6 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_7 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_8 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_9 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_10 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_11 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_12 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_13 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_14 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_15 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_16 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_17 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_18 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_19 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_20 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_21 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_22 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_23 %in% prcse2p_list ~ TRUE,
      OTH_SURG_PROC_CODE_24 %in% prcse2p_list ~ TRUE,
      TRUE                     ~  FALSE
    )
  )

del_csec %>% 
  count(PRCSE2P)

```

### Create Primary Cesarean column

Test if PRCSE2G is TRUE and PRCSE2P is FALSE.

```{r pcsec}

del_pcsec <- del_csec %>% 
  mutate(
    PCSEC = if_else((PRCSE2G == T & PRCSE2P == F), T, F)
  )


```

## Primary Cesarean rate statewide

```{r pcsec_prc}
del_pcsec %>% 
  tabyl(PCSEC) %>% 
  rename(count = n) %>% 
  adorn_pct_formatting()
```


**The TRUE value above is the percentage of deliveries involving all low-risk mothers without prior cesareans that result in a cesarean section.**

## Laredo Hospital Primary Cesarean section rate

Filter for the Laredo hospitals.

```{r pcsec_laredo_filter}
laredo_pcsec <- del_pcsec %>% 
  filter(
     str_detect(PROVIDER_NAME, "Laredo")
  )

laredo_pcsec %>% 
  count(PROVIDER_NAME)
```

### Three-year Rate for Laredo hospitals

```{r pcsec_laredo_rate}
laredo_pcsec %>% 
  tabyl(PROVIDER_NAME, PCSEC) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns()
```

**The TRUE value above is the percentage of deliveries involving all low-risk mothers without prior cesareans that result in a cesarean section.**

### Yearly rate for all hospitals

Set up a tibble that has the yearly rate for each hospital.

```{r pcsec_rate_yr_all}
pcsec_rate_yr_all <- del_pcsec %>% 
  group_by(YR, PROVIDER_NAME, PCSEC) %>% 
  summarize(CNT = n()) %>% 
  pivot_wider(names_from = PCSEC, values_from = CNT) %>% 
  rename(
    NPCSEC_CNT = "FALSE",
    PCSEC_CNT = "TRUE"
  ) %>% 
  mutate(
    TOTAL = NPCSEC_CNT + PCSEC_CNT
  ) %>% 
  filter(TOTAL >= 100) %>% 
  mutate(
    PCRATE = round((PCSEC_CNT / TOTAL) * 100,1)
  ) %>%
    arrange(PCRATE %>% desc())

# peek at table
pcsec_rate_yr_all %>% head()
```

### Laredo hospital rates per year

```{r pcsec_rate_yr_lar}
pcsec_rate_yr_lar <- pcsec_rate_yr_all %>% 
  filter(
    str_detect(PROVIDER_NAME, "Laredo")
  )
```

### Table of Laredo hospital primary Cesarean Rates by year

```{r pcsec_rate_yr_lar_table}
pcsec_rate_yr_lar %>% 
  arrange(YR) %>% 
  select(YR, PROVIDER_NAME, PCRATE) %>% 
  pivot_wider(names_from = YR, values_from = PCRATE)
```

### Chart of Laredo hospital primary Cesarean Rates by year

```{r pcsec_rate_yr_lar_plot}
pcsec_rate_yr_lar %>% 
  ggplot(aes(YR, PCRATE)) +
  geom_line(aes(group = PROVIDER_NAME, color = PROVIDER_NAME)) +
  expand_limits(y = c(0,40)) +
  theme(legend.position="bottom", legend.box = "vertical") +
  labs(title = "Primary Cesarean rate by year", x = "YEAR", y = "Primary Cesarean Rate")

```

## Write files

We write some dataframes to rds for later use.

```{r write}
del_pcsec %>% write_rds("data-processed/pcsec.rds")

pcsec_rate_yr_all %>% write_rds("data-processed/pcsec_rate_yr_all.rds")

# A klaxon to indicate the processing is complete
beepr::beep(4)
```

