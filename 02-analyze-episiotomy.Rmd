---
title: "Leapfrog Episiotomy rates, 2016-2q2019"
output:
  html_document:
    df_print: paged
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---

By **Christian McDonald**, Assistant Professor of Practice\
School of Journalism, Moody College of Communication\
University of Texas at Austin

This analysis looks at episiotomy rates using the [Texas Health Care Information Collection's Texas Inpatient Public Use Data File](https://www.dshs.texas.gov/thcic/hospitals/Inpatientpudf.shtm). The definition to calculate the rates comes from the [2019 Leapfrog Hospital Survey p103](https://www.leapfroggroup.org/sites/default/files/Files/2019HospitalSurvey_20190529_v8.0%20%28version%203%29.pdf).

> To start this analysis, I've start with data filtered using the 2019 Leapfrog Hospital Survey specs for Episiotomy (p103). The process was done in "01-process-lf-epi-loop".

## Setup and import

```{r setup, echo=T, results='hide', message=F, warning=F}
library(tidyverse)
library(janitor)
library(DT)
```

```{r imports}
### production data
del_vag_excl <- read_rds("data-processed/lf_del_vag.rds")

del_vag_excl %>% nrow()
```


### Set the episiotomy cases

This creates a column for cases where episiotomy is true. We have to look through each of the surgical procedure columns to check for the code.

> I'd like to refactor this method, but at least it is easy to see and understand.

```{r epi_col}
# list of codes for episiotmy, which is really one: 0W8NXZZ
epi_list <- read_rds("procedures-lists/lf_epi.rds") %>% .$epi
epi_list

del_epi <- del_vag_excl %>% 
  mutate(
    EPI = case_when(
      PRINC_SURG_PROC_CODE %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_1 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_2 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_3 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_4 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_5 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_6 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_7 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_8 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_9 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_10 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_11 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_12 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_13 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_14 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_15 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_16 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_17 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_18 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_19 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_20 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_21 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_22 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_23 %in% epi_list ~ TRUE,
      OTH_SURG_PROC_CODE_24 %in% epi_list ~ TRUE,
      TRUE ~ FALSE
    )
  )

```

## Statewide episiotomy rate, 2016-2q2019

We combine all years of data to compare the percentage of episiotomy cases. The **TRUE** value is the percentage of cases where an episiotomy is performed.

```{r rate_state}
del_epi %>% 
  tabyl(EPI) %>% 
  rename(count = n) %>% 
  adorn_pct_formatting()
```

## Searchable table: Episiotomy rates by hospital, combined years

Hospitals with fewer than 100 deliveries excluded.

```{r rate_combo_state_table}
del_epi_data <- del_epi %>%
  group_by(PROVIDER_NAME, EPI) %>% 
  summarise(
    EPI_CNT = n()
  ) %>% 
  pivot_wider(names_from = EPI, values_from = EPI_CNT) %>% 
  rename(
    EPIF = "FALSE",
    EPIT = "TRUE"
  ) %>% 
  mutate(
    TOTAL = EPIF + EPIT,
    EPIRATE = round((EPIT / TOTAL) * 100,1)
  ) %>% 
  select(PROVIDER_NAME, TOTAL, EPIF, EPIT, EPIRATE) %>% 
  filter(TOTAL >= 100) %>% 
  arrange(EPIRATE %>% desc())

del_epi_data %>%   
    datatable()
```

### Mean, Median of episiotomy rates by hospital

The mean/median taken from the episiotomy rate of each hospital.

```{r stats_tx}
del_epi_data %>% 
  ungroup() %>% 
  summarise(
    MEAN = round(mean(EPIRATE, na.rm=TRUE),2),
    MEDIAN = median(EPIRATE, na.rm=TRUE)
  )
```

### Episiotomy rates by hospital, by year

A look at the episiotomy rates for hospitals by year. We create the rate using the EPI column we created above, then pivot to do the math. We pivot again to see the years nicely in a table.

```{r by_year}
# pivot to crate the rate based on logical EPI column
del_epi_yr_data <- del_epi %>% 
  group_by(YR, PROVIDER_NAME, EPI) %>% 
  summarise(
    EPI_CNT = n()
  ) %>% 
  pivot_wider(names_from = EPI, values_from = EPI_CNT) %>% 
  rename(
    EPIF = "FALSE",
    EPIT = "TRUE"
  ) %>% 
  mutate(
    TOTAL = EPIF + EPIT,
    EPIRATE = round((EPIT / TOTAL) * 100,1)
  )

# select, pivot to see years.
del_epi_yr_table <- del_epi_yr_data %>% 
  filter(TOTAL >= 100) %>% 
  select(YR, PROVIDER_NAME, EPIRATE) %>% 
  pivot_wider(names_from = YR, values_from = EPIRATE) %>% 
  arrange(`2019` %>% desc())

del_epi_yr_table %>% datatable()
```

## Laredo hospitals

### Episiotomy rate combined year, Laredo hospitals

From combined years of the data.

```{r rate_laredo}
# filter for laredo hospitals

del_epi %>% 
  filter(str_detect(PROVIDER_NAME, "Laredo")) %>% 
  tabyl(PROVIDER_NAME, EPI) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns()
```

### Episiotomy rates by year, Laredo hospitals

The table above, filtered for Laredo.

```{r by_yr_laredo}
# filter for Laredo
del_epi_yr_table %>% 
  filter(str_detect(PROVIDER_NAME, "Laredo"))
```

## Write files

Writing out some data frames for use in other notebooks

```{r write}
# del_epi %>% write_rds("data-processed/epi.rds")

beepr::beep(4)
```


